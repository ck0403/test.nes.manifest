name: Update Commits in default.xml

on:
  push:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  update-commits:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Still needed for the workflow
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Use PAT instead of default GITHUB_TOKEN
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          
      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Get commit information
        id: commit-info
        run: |
          echo "COMMIT_HASH=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "COMMIT_DATE=$(git log -1 --format='%cd' --date=iso-strict)" >> $GITHUB_OUTPUT
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          # Escape for JSON
          COMMIT_MSG_ESCAPED=$(echo "$COMMIT_MSG" | python3 -c "import sys, json; print(json.dumps(sys.stdin.read()))")
          echo "COMMIT_MESSAGE=$COMMIT_MSG_ESCAPED" >> $GITHUB_OUTPUT
          
      - name: Update default.xml
        run: |
          echo "Updating default.xml with commit ${{ steps.commit-info.outputs.COMMIT_HASH }}"
          python .github/scripts/auto_update_manifest.py \
            --commit "${{ steps.commit-info.outputs.COMMIT_HASH }}" \
            --branch "${{ steps.commit-info.outputs.BRANCH_NAME }}" \
            --message "${{ steps.commit-info.outputs.COMMIT_MESSAGE }}" \
            --date "${{ steps.commit-info.outputs.COMMIT_DATE }}"
            
      - name: Commit and push changes
        run: |
          if git diff --quiet default.xml; then
            echo "No changes to default.xml"
          else
            git add default.xml
            git commit -m "chore: update default.xml with commit ${{ steps.commit-info.outputs.COMMIT_HASH }}"
            git push
            echo "âœ… Successfully updated default.xml"
          fi